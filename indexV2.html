<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <span class="lightbox-close">âœ•</span>
  <img id="lightboxImg" src="" alt="">
</div>

<!-- ADD PAGE -->
<div class="page active" id="page-add">
  <div class="form-wrap">
    <div>
      <div class="field-label">Nom du jeu *</div>
      <input type="text" id="gameName" placeholder="Ex: Flip 7, Rebirthâ€¦">
    </div>
    <div>
      <div class="field-label">Ã‰diteur</div>
      <input type="text" id="gameEditor" placeholder="Ex: Repos Productionâ€¦">
    </div>
    <div>
      <div class="field-label">Jour</div>
      <div class="day-btns">
        <button class="day-btn on" onclick="selectDay(this,'Jeu 26')">Jeu 26</button>
        <button class="day-btn" onclick="selectDay(this,'Ven 27')">Ven 27</button>
        <button class="day-btn" onclick="selectDay(this,'Sam 28')">Sam 28</button>
        <button class="day-btn" onclick="selectDay(this,'Dim 1')">Dim 1</button>
      </div>
    </div>
    <div>
      <div class="field-label">Note</div>
      <div class="stars" id="starRating">
        <span class="star" onclick="setStars(1)">â˜…</span>
        <span class="star" onclick="setStars(2)">â˜…</span>
        <span class="star" onclick="setStars(3)">â˜…</span>
        <span class="star" onclick="setStars(4)">â˜…</span>
        <span class="star" onclick="setStars(5)">â˜…</span>
      </div>
    </div>
    <div>
      <div class="field-label">DÃ©cision</div>
      <div class="pills">
        <div class="pill buy" onclick="selectDecision('buy',this)">ðŸ›’ Acheter</div>
        <div class="pill retry" onclick="selectDecision('retry',this)">ðŸ”„ Retester</div>
        <div class="pill skip" onclick="selectDecision('skip',this)">âœ— Non merci</div>
      </div>
    </div>
    <div>
      <div class="field-label">Prix repÃ©rÃ©</div>
      <input type="text" id="gamePrice" placeholder="Ex: 35 â‚¬">
    </div>
    <div>
      <div class="field-label">Photos</div>
      <div class="photo-zone">
        <div class="photo-thumbs" id="newPhotos"></div>
        <label class="photo-add-btn">
          <span style="font-size:20px">ðŸ“·</span> Ajouter une photo
          <input type="file" accept="image/*" capture="environment" class="photo-input" id="photoInput" onchange="addPhoto(event)" multiple>
        </label>
      </div>
    </div>
    <div>
      <div class="field-label">Notes / impressions</div>
      <textarea id="gameNote" placeholder="MÃ©canique, thÃ¨me, durÃ©e de partieâ€¦"></textarea>
    </div>
    <button class="btn-save" id="saveBtn" onclick="saveGame()">ENREGISTRER LE JEU</button>
  </div>
</div>

<!-- LIST PAGE -->
<div class="page" id="page-list">
  <div class="filter-bar">
    <div class="chip on" onclick="setFilter('all',this)">Tous</div>
    <div class="chip" onclick="setFilter('buy',this)">ðŸ›’ Acheter</div>
    <div class="chip" onclick="setFilter('retry',this)">ðŸ”„ Retester</div>
    <div class="chip" onclick="setFilter('skip',this)">âœ— Non</div>
    <div class="chip" onclick="setFilter('photo',this)">ðŸ“· Avec photos</div>
  </div>
  <div class="storage-bar" id="storageBar"></div>
  <div class="list-wrap" id="gameList"></div>
</div>

<!-- STATS PAGE -->
<div class="page" id="page-stats">
  <div class="stats-wrap" id="statsWrap"></div>
</div>

<script>
const DB_KEY = 'cannes2026_v2';
let games = [];
let currentStars = 0, currentDecision = '', currentDay = 'Jeu 26', currentFilter = 'all';
let pendingPhotos = [];

try { games = JSON.parse(localStorage.getItem(DB_KEY) || '[]'); } catch(e) { games = []; }
document.getElementById('totalCount').textContent = games.length;

function save() {
  try {
    localStorage.setItem(DB_KEY, JSON.stringify(games));
    document.getElementById('totalCount').textContent = games.length;
    checkStorage();
  } catch(e) {
    alert('âš ï¸ Stockage plein ! Supprime quelques photos pour continuer.');
  }
}

function checkStorage() {
  try {
    const used = new Blob(Object.values(localStorage)).size;
    const mb = (used / 1024 / 1024).toFixed(1);
    const bar = document.getElementById('storageBar');
    bar.textContent = (used > 3*1024*1024 ? `âš ï¸ Stockage utilisÃ© : ${mb} MB â€” supprime des photos` : `ðŸ’¾ Stockage utilisÃ© : ${mb} MB`);
    bar.classList.add('visible');
  } catch(e) {}
}

function compressImage(file, maxW=800, quality=0.6) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height;
        if(w > maxW){ h = Math.round(h*maxW/w); w = maxW; }
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img,0,0,w,h);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

async function addPhoto(event){
  const files = Array.from(event.target.files);
  for(const file of files){
    const dataUrl = await compressImage(file);
    pendingPhotos.push(dataUrl);
  }
  renderPendingPhotos();
  event.target.value='';
}

function renderPendingPhotos(){
  const wrap = document.getElementById('newPhotos');
  wrap.innerHTML = pendingPhotos.map((p,i)=>`
    <div class="photo-thumb-wrap">
      <img class="photo-thumb" src="${p}" onclick="openLightbox('${p}')">
      <button class="photo-del" onclick="removePendingPhoto(${i})">âœ•</button>
    </div>`).join('');
}

function removePendingPhoto(i){
  pendingPhotos.splice(i,1);
  renderPendingPhotos();
}

function saveGame(){
  const name = document.getElementById('gameName').value.trim();
  if(!name){ document.getElementById('gameName').focus(); return; }
  const game = {
    id: Date.now(),
    name,
    editor: document.getElementById('gameEditor').value.trim(),
    day: currentDay, stars: currentStars, decision: currentDecision,
    price: document.getElementById('gamePrice').value.trim(),
    note: document.getElementById('gameNote').value.trim(),
    photos: [...pendingPhotos]
  };
  games.unshift(game);
  save();
  resetForm();
  const btn = document.getElementById('saveBtn');
  btn.textContent='âœ“ ENREGISTRÃ‰ !'; btn.classList.add('ok');
  setTimeout(()=>{ btn.textContent='ENREGISTRER LE JEU'; btn.classList.remove('ok'); },1500);
}

function resetForm(){
  document.getElementById('gameName').value='';
  document.getElementById('gameEditor').value='';
  document.getElementById('gamePrice').value='';
  document.getElementById('gameNote').value='';
  currentStars=0; currentDecision=''; pendingPhotos=[];
  document.querySelectorAll('.star').forEach(s=>s.classList.remove('on'));
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.day-btn').forEach((b,i)=>b.classList.toggle('on', i===0));
  currentDay='Jeu 26';
  renderPendingPhotos();
}

function selectDay(btn, day){
  document.querySelectorAll('.day-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on'); currentDay=day;
}
function setStars(n){
  currentStars=n;
  document.querySelectorAll('.star').forEach((s,i)=>s.classList.toggle('on', i<n));
}
function selectDecision(type, el){
  currentDecision=type;
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('on'));
  el.classList.add('on');
}

function showTab(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.querySelectorAll('.tab')[['add','list','stats'].indexOf(name)].classList.add('active');
  if(name==='list') renderList();
  if(name==='stats') renderStats();
}

function setFilter(f, el){
  currentFilter=f;
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('on'));
  el.classList.add('on'); renderList();
}

const decisionMeta = { buy:{label:'ðŸ›’ Acheter', cls:'buy'}, retry:{label:'ðŸ”„ Retester', cls:'retry'}, skip:{label:'âœ— Non merci', cls:'skip'} };
function starsStr(n){ return n? 'â˜…'.repeat(n)+'â˜†'.repeat(5-n) : 'â€”'; }

function renderList(){
  checkStorage();
  let filtered = currentFilter==='all' ? games
    : currentFilter==='photo' ? games.filter(g=>g.photos && g.photos.length)
    : games.filter(g=>g.decision===currentFilter);
  const el=document.getElementById('gameList');
  if(!filtered.length){
    el.innerHTML='<div class="empty"><div class="empty-icon">ðŸŽ²</div>Aucun jeu ici encore.</div>';
    return;
  }
  el.innerHTML = filtered.map(g=>`
    <div class="game-card ${g.decision||''}">
      <div class="gc-top">
        <div>
          <div class="gc-name">${g.name}</div>
          ${g.editor?`<div class="gc-editor">${g.editor}</div>`:''}
        </div>
        <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
          <div class="gc-stars">${starsStr(g.stars)}</div>
          <div class="gc-del" onclick="deleteGame(${g.id})">ðŸ—‘</div>
        </div>
      </div>
      <div class="gc-meta">
        <span class="badge day">${g.day}</span>
        ${g.decision?`<span class="badge ${g.decision}">${decisionMeta[g.decision].label}</span>`:''}
        ${g.price?`<span class="gc-price">${g.price}</span>`:''}
        ${g.photos && g.photos.length?`<span style="font-size:12px;color:var(--muted)">ðŸ“· ${g.photos.length}</span>`:''}
      </div>
      ${g.note?`<div class="gc-note">${g.note}</div>`:''}
      ${g.photos && g.photos.length?`<div class="gc-photos">${g.photos.map(p=>`<img class="gc-photo" src="${p}" onclick="openLightbox('${p}')" loading="lazy">`).join('')}</div>`:''}
    </div>
  `).join('');
}

function deleteGame(id){
  if(!confirm('Supprimer ce jeu ?')) return;
  games=games.filter(g=>g.id!==id);
  save(); renderList();
}

function openLightbox(src){
  document.getElementById('lightboxImg').src=src;
  document.getElementById('lightbox').classList.add('open');
}
function closeLightbox(){ document.getElementById('lightbox').classList.remove('open'); }

function renderStats(){
  const total=games.length;
  const toBuy=games.filter(g=>g.decision==='buy');
  const toRetry=games.filter(g=>g.decision==='retry');
  const rated=games.filter(g=>g.stars);
  const avg=rated.length?(rated.reduce((s,g)=>s+g.stars,0)/rated.length).toFixed(1):'â€”';
  const totalPhotos=games.reduce((s,g)=>s+(g.photos?g.photos.length:0),0);
  const perDay={'Jeu 26':0,'Ven 27':0,'Sam 28':0,'Dim 1':0};
  games.forEach(g=>{ if(perDay[g.day]!==undefined) perDay[g.day]++; });

  document.getElementById('statsWrap').innerHTML=`
    <div class="stat-row"><div class="stat-label">Jeux testÃ©s</div><div class="stat-val gold">${total}</div></div>
    <div class="stat-row"><div class="stat-label">Ã€ acheter</div><div class="stat-val green">${toBuy.length}</div></div>
    <div class="stat-row"><div class="stat-label">Ã€ retester</div><div class="stat-val orange">${toRetry.length}</div></div>
    <div class="stat-row"><div class="stat-label">Note moyenne</div><div class="stat-val gold">${avg}${avg!=='â€”'?'â˜…':''}</div></div>
    <div class="stat-row"><div class="stat-label">Photos prises</div><div class="stat-val" style="color:var(--muted)">ðŸ“· ${totalPhotos}</div></div>
    <div class="stat-row" style="flex-direction:column;align-items:stretch;gap:10px">
      <div class="stat-label">Par jour</div>
      ${Object.entries(perDay).map(([d,n])=>`
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:14px">${d}</span>
          <span style="font-weight:900;font-size:22px;color:var(--red)">${n} jeu${n>1?'x':''}</span>
        </div>`).join('')}
    </div>
    ${toBuy.length?`<div class="buy-list"><div class="buy-list-title">ðŸ›’ Liste d'achats</div>${toBuy.map(g=>`<div class="buy-item"><span class="buy-item-name">${g.name}</span><span class="buy-item-price">${g.price||'?'}</span></div>`).join('')}</div>`:''}
  `;
}
</script>
</body>
</html>
